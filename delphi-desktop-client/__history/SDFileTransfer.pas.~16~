unit SDFileTransfer;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ComCtrls, StrUtils, CPort,
  Vcl.Grids, Vcl.DBGrids;

type
  TFSDFileTransfer = class(TForm)
    Button1: TButton;
    PBTransmission: TProgressBar;
    Memo1: TMemo;
    Label1: TLabel;
    GRData: TDBGrid;
    procedure onPacket(const Str: String);
    procedure Button1Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
  private
    { Private-Deklarationen }
    line: String;
    headers, body, buffer: TStringList;
    state, lastCount: Integer;
  public
    { Public-Deklarationen }
    ComPort: TComPort;
  end;

var
  FSDFileTransfer: TFSDFileTransfer;

implementation

procedure TFSDFileTransfer.onPacket(const Str: String);
var
  colNames: TStringList;
  col: TColumn;
  i: Integer;
begin
  Memo1.Text := Memo1.Text + Str;

  if(Memo1.Lines[Memo1.Lines.Count-2]='--HEADERS--') then
  begin
    state:=0;
  end else if(Memo1.Lines[Memo1.Lines.Count-2]='--BODY--') then
  begin
    state:=1;
  end else if(Memo1.Lines[Memo1.Lines.Count-1]='---TRANSMISSION-END---') then
  begin
    state:=-1;
    ShowMessage('Übertragung abgeschlossen');
    //ShowMessage(headers.Text);
    //ShowMessage(body[body.Count-1]);
  end else begin
    if(Memo1.Lines.Count>lastCount) then
    begin
      lastCount:=Memo1.Lines.Count;
      case state of
        0: headers.Add(Memo1.Lines[Memo1.Lines.Count-2]);
        1: begin
          body.Add(Memo1.Lines[Memo1.Lines.Count-2]);
          PBTransmission.Position:=PBTransmission.Position+Length(Memo1.Lines[Memo1.Lines.Count-2])+3;
        end;
      end;

      if(headers.Count=2) then
      begin
        PBTransmission.Max:= StrToInt(Copy(headers[1], 6));
      end;
      if(headers.Count=3) AND GRData.Columns.Count=0 then
      begin
        colNames:=TStringList.Create;
        colNames.Delimiter:=';';
        colNames.DelimitedText:=headers[2];

        for i := 0 to colNames.Count-1 do
        begin
          col := GRData.Columns.Add;
          col.FieldName:=colNames[i];
        end;

      end;
    end;
  end;
end;

{$R *.dfm}

procedure TFSDFileTransfer.Button1Click(Sender: TObject);
begin
  if(ComPort.Connected=true) then
  begin
    Memo1.Text:='';
    lastCount:=0;
    headers.Clear;
    body.Clear;
    PBTransmission.Position:=0;
    ComPort.WriteStr('logSD'+chr(13));
  end;
end;

procedure TFSDFileTransfer.FormCreate(Sender: TObject);
begin
  state:=-1;
  headers:=TStringList.Create;
  body:=TStringList.Create;
end;

procedure TFSDFileTransfer.FormDestroy(Sender: TObject);
begin
  headers.Free;
  body.Free;
end;

end.
